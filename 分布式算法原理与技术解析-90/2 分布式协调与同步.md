## 03 分布式互斥

分布式互斥 Distributed Mutual Exclusion

临界资源 Critical Resource



### 霸道总裁：集中式算法

> 引入一个协调者程序，得到一个分布式互斥算法。每个程序在需要访问临界资源时，先给协调者发送一个请求。如果当前没有程序使用这个资源，协调者直接授权请求程序访问；否则，按照先来后到的顺序为请求程序“排一个号”。如果有程序使用完资源，则通知协调者，协调者从“排号”的队列里取出排在最前面的请求，并给它发送授权消息。拿到授权消息的程序，可以直接去访问临界资源。

<img src="pic\集中式算法.png" alt="image-20210102203150297" style="zoom:50%;" />

> 每个程序完成一次临界资源访问，需要进行 3 次消息交互



所有程序只需和协调者通信，程序之间无需通信



优点

- 简单、易于实现

缺点 

- 协调者容易出现问题（在使用集中式算法的时候，一定要选择性能好、可靠性高的服务器来运行协调者，或可以对主从进行同步备份）
  - 协调者会成为系统的性能瓶颈
  - 单点故障



### 民主协商：分布式算法

> 当一个程序要访问临界资源时，先向系统中的其他程序发送一条请求消息，在接收到所有程序返回的同意消息后，才可以访问临界资源。其中，请求消息需要包含所请求的资源、请求者的 ID，以及发起请求的时间。

<img src="pic\分布式算法-1.png" alt="image-20210102204508358" style="zoom:50%;" />

<img src="pic\分布式算法-2.png" alt="image-20210102204529673" style="zoom:50%;" />

<img src="pic\分布式算法-3.png" alt="image-20210102204728717" style="zoom:50%;" />

信息交互：

1. 向其他 n-1 个程序发送访问临界资源的请求，总共需要 n-1 次消息交互
2. 接收到其他 n-1 个程序回复的同意消息，方可访问资源，总共需要 n-1 次消息交互

> 一个程序要成功访问临界资源，至少需要 2*(n-1) 次消息交互，消息数量会随着需要访问临界资源的程序数量呈指数级增加，容易导致高昂的 “沟通成本”



“先到先得”和“投票全票通过”两个机制，让每个程序按时间顺序公平地访问资源



优点：简单粗暴、易于实现

缺点：

- 通信成本高：当系统内需要访问临界资源的程序增多时，容易产生“信令风暴”，也就是程序收到的请求完全超过了自己的处理能力，而导致自己正常的业务无法开展。
- 可用性很低：一旦某一程序发生故障，无法发送同意消息，那么其他程序均处在等待回复的状态中，使得整个系统处于停滞状态，导致整个系统不可用（我自己使用完之后，还没等回复，我就坏了，那么这个资源接下来不能再被继续使用）
  - 改进：如果检测到一个程序故障，则直接忽略这个程序，但这样每个程序都需要对其他程序进行故障检测，这无疑带来了更大的复杂性



**分布式算法适合节点数目少且变动不频繁的系统（临界资源使用频率较低），每个程序均需通信交互**



HDFS 的文件修改

<img src="pic\HDFS文件修改.png" alt="image-20210102210000530" style="zoom:50%;" />





### 轮值 CEO：令牌环算法

> 令牌按照顺时针（或逆时针）方向在程序之间传递，收到令牌的程序有权访问临界资源，访问完成后将令牌传送到下一个程序；若该程序不需要访问临界资源，则直接把令牌传送给下一个程序。

<img src="pic\令牌环算法.png" alt="image-20210102211218129" style="zoom:50%;" />

优点：不需要征求其他程序的意见，所以有更高的通信效率

缺点：

- 单点故障（也可通过 直接将令牌传递给故障程序的下一个程序 解决）
- 当临界资源使用较低时，会带来较多无用通信



**适用于系统规模较小，并且系统中每个程序使用临界资源的频率高且使用时间比较短的场景**



适合大规模的分布式互斥算法：两层结构的分布式令牌环算法





-------------





<img src="pic\互斥算法总结.png" alt="image-20210102212054668" style="zoom: 50%;" />





## 04 分布式选举













## 05 分布式共识